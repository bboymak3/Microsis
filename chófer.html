<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Ruta - Chofer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h2 id="saludo">Hola, Chofer</h2>
        <div id="info-unidad" style="font-size: 14px; color: #ecf0f1;"></div>
    </header>

    <main style="padding: 15px;">
        <h3>Mis Viajes de Hoy</h3>
        <div id="contenedor-viajes">
            <p>Buscando viajes asignados...</p>
        </div>
    </main>

    <div id="modalCierre" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; color:white; padding:20px;">
        <h3>Finalizar Viaje</h3>
        <p>¬øHubo alg√∫n inconveniente en el camino?</p>
        <select id="sel_incidente" style="width:100%; padding:15px; margin-bottom:15px; border-radius:5px;">
            <option value="Ninguno">Ninguno (Todo bien)</option>
            <option value="Lluvia">Lluvia</option>
            <option value="Accidente">Accidente en la v√≠a</option>
            <option value="Dano Leve">Da√±o Leve del veh√≠culo</option>
            <option value="Dano Grave">Da√±o Grave del veh√≠culo</option>
            <option value="Alcabala">Retraso por Alcabala</option>
            <option value="Otros">Otros</option>
        </select>
        <textarea id="notas_cierre" placeholder="Notas adicionales (opcional)..." style="width:100%; height:100px; border-radius:5px; padding:10px;"></textarea>
        <button onclick="enviarCierre()" style="background:#27ae60; color:white; width:100%; padding:15px; border:none; margin-top:15px; font-weight:bold; border-radius:5px;">CONFIRMAR Y CERRAR RUTA</button>
        <button onclick="document.getElementById('modalCierre').style.display='none'" style="background:transparent; color:white; width:100%; padding:10px; border:1px solid white; margin-top:10px; border-radius:5px;">Cancelar</button>
    </div>

    <script>
        let usuarioId = localStorage.getItem('userId'); // Se guarda al hacer login
        let viajeActivoId = null;

        async function cargarViajes() {
            // En una app real, aqu√≠ pedimos los viajes del usuarioId
            // Por ahora, simulamos la carga para que veas la estructura
            const contenedor = document.getElementById('contenedor-viajes');
            contenedor.innerHTML = `
                <div class="perfil-container" style="border-left: 10px solid #f39c12;">
                    <h4>üìç Valencia - 08:30 AM</h4>
                    <p>Estado: EN CURSO (Naranja)</p>
                    <button onclick="abrirModalCierre(1)" class="btn-verde" style="width:100%; padding:15px;">FINALIZAR VIAJE</button>
                </div>
            `;
        }

        function obtenerGPS() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
                    err => { alert("Por favor activa el GPS"); reject(err); }
                );
            });
        }

        async function iniciarViaje(idViaje) {
            const pasajeros = prompt("Ingrese cantidad de pasajeros al salir:");
            if (!pasajeros) return;

            const coords = await obtenerGPS();
            
            await fetch('/api/update-viaje', {
                method: 'POST',
                body: JSON.stringify({
                    viajeId: idViaje,
                    estado: 2, // Naranja
                    lat: coords.lat,
                    lon: coords.lon,
                    pasajeros: pasajeros
                })
            });
            location.reload();
        }

        function abrirModalCierre(idViaje) {
            viajeActivoId = idViaje;
            document.getElementById('modalCierre').style.display = 'block';
        }

        async function enviarCierre() {
            const incidente = document.getElementById('sel_incidente').value;
            const notas = document.getElementById('notas_cierre').value;
            const coords = await obtenerGPS();

            await fetch('/api/update-viaje', {
                method: 'POST',
                body: JSON.stringify({
                    viajeId: viajeActivoId,
                    estado: 3, // Verde
                    lat: coords.lat,
                    lon: coords.lon,
                    incidente: incidente,
                    notas: notas
                })
            });
            alert("Ruta finalizada correctamente. Buen trabajo.");
            location.reload();
        }

        // AUTO-GPS: Env√≠a ubicaci√≥n cada 5 minutos si hay un viaje naranja
        setInterval(async () => {
            if(viajeActivoId) {
                const coords = await obtenerGPS();
                fetch('/api/update-viaje', {
                    method: 'POST',
                    body: JSON.stringify({ viajeId: viajeActivoId, lat: coords.lat, lon: coords.lon, estado: 2 })
                });
            }
        }, 300000); // 300,000ms = 5 minutos

        window.onload = cargarViajes;
    </script>
</body>
</html>
