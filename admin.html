<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Global Pro Automotriz</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <header>
        <h1>Control Global Pro 24/7</h1>
        <div id="status-bar">
            <button class="btn-rojo">PENDIENTES</button>
            <button class="btn-naranja">EN RUTA</button>
            <button class="btn-verde">FINALIZADOS</button>
        </div>
    </header>

    <main style="padding: 15px;">
        <section class="perfil-container">
            <h3>Ficha T√©cnica del Chofer (Com01-100)</h3>
            <select id="selector" onchange="cargarPerfil(this.value)" style="width:100%; padding:12px; margin-bottom:15px;">
                <option value="">Seleccione un Puesto...</option>
            </select>

            <form id="perfilForm" class="grid-form">
                <input type="hidden" name="cedula_id" id="f_id">
                <label>Nombre: <input type="text" name="nombre" id="f_nombre"></label>
                <label>Placa/Clave: <input type="text" name="placa_buseta" id="f_placa"></label>
                <label>Serial Motor: <input type="text" name="serial_motor" id="f_serial"></label>
                <label>Tipo Sangre: <input type="text" name="tipo_sangre" id="f_sangre"></label>
                <label>Tlf Familiar: <input type="text" name="contacto_familiar" id="f_fam"></label>
                <label>Usa Lentes: <input type="checkbox" name="usa_lentes" id="f_lentes"></label>
                <button type="button" onclick="guardarPerfil()" class="btn-save" style="background:#2c3e50; color:white; padding:12px; width:100%; border:none; margin-top:10px;">GUARDAR DATOS</button>
            </form>
        </section>

        <section style="margin-top:20px;">
            <h3>Mapa en Tiempo Real (Unidades Naranjas)</h3>
            <div id="map" style="height: 350px; border-radius:10px; border:2px solid #333;"></div>
        </section>

        <section class="perfil-container" style="margin-top:20px; border-top: 5px solid #3498db;">
            <h3>Agregar Nuevo Destino</h3>
            <div class="grid-form">
                <input type="text" id="new_destino" placeholder="Ej: Barquisimeto">
                <input type="text" id="new_horarios" placeholder="08:30, 10:00, 15:00">
                <button onclick="agregarRuta()" style="background:#27ae60; color:white; border:none; padding:10px;">A√ëADIR RUTA</button>
            </div>
            <div id="lista-rutas" style="margin-top:10px;"></div>
        </section>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = L.map('map').setView([8.62, -70.20], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = {};

        async function init() {
            const res = await fetch('/api/usuarios');
            const data = await res.json();
            const sel = document.getElementById('selector');
            data.filter(u => u.rol === 'chofer').forEach(u => {
                sel.innerHTML += `<option value="${u.cedula_id}">${u.cedula_id} - ${u.nombre}</option>`;
            });
            cargarRutas();
        }

        async function cargarPerfil(id) {
            if(!id) return;
            const res = await fetch(`/api/usuarios?id=${id}`);
            const u = await res.json();
            document.getElementById('f_id').value = u.cedula_id;
            document.getElementById('f_nombre').value = u.nombre;
            document.getElementById('f_placa').value = u.placa_buseta;
            document.getElementById('f_serial').value = u.serial_motor || '';
            document.getElementById('f_sangre').value = u.tipo_sangre || '';
            document.getElementById('f_fam').value = u.contacto_familiar || '';
            document.getElementById('f_lentes').checked = u.usa_lentes === 1;
        }

        async function guardarPerfil() {
            const data = Object.fromEntries(new FormData(document.getElementById('perfilForm')));
            data.usa_lentes = document.getElementById('f_lentes').checked;
            await fetch('/api/usuarios/update', { method:'POST', body: JSON.stringify(data) });
            alert("Informaci√≥n actualizada en D1");
        }

        async function agregarRuta() {
            const destino = document.getElementById('new_destino').value;
            const horarios = document.getElementById('new_horarios').value;
            await fetch('/api/rutas', { method:'POST', body: JSON.stringify({destino, horarios}) });
            location.reload();
        }

        async function cargarRutas() {
            const res = await fetch('/api/rutas');
            const rutas = await res.json();
            const list = document.getElementById('lista-rutas');
            rutas.forEach(r => list.innerHTML += `<p>üìç ${r.destino} (${r.horarios})</p>`);
        }

        setInterval(async () => {
            const res = await fetch('/api/mapa-vivo');
            const data = await res.json();
            data.forEach(u => {
                if(markers[u.cedula_id]) markers[u.cedula_id].setLatLng([u.ultima_latitud, u.ultima_longitud]);
                else markers[u.cedula_id] = L.marker([u.ultima_latitud, u.ultima_longitud]).addTo(map).bindPopup(u.cedula_id);
            });
        }, 15000);

        window.onload = init;
    </script>
</body>
</html>