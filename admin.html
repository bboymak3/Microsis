<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Pro - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <header>
        <h1>Control Global Pro Automotriz</h1>
        <nav id="status-bar">
            <button class="btn-rojo">PENDIENTES</button>
            <button class="btn-naranja">EN RUTA</button>
            <button class="btn-verde">FINALIZADOS</button>
        </nav>
    </header>

    <main>
        <div class="perfil-container">
            <div style="width:100%">
                <h3>Gesti√≥n de Fichas (Com01 - Com100)</h3>
                <select id="selector" onchange="cargar(this.value)" style="width:100%; padding:10px;">
                    <option value="">Seleccione un Puesto...</option>
                </select>
            </div>

            <form id="perfilForm" class="grid-form">
                <input type="hidden" name="cedula_id" id="f_id">
                <label>Nombre: <input type="text" name="nombre" id="f_nombre"></label>
                <label>Placa/Clave: <input type="text" name="placa_buseta" id="f_placa"></label>
                <label>Serial Motor: <input type="text" name="serial_motor" id="f_serial"></label>
                <label>Tipo Sangre: <input type="text" name="tipo_sangre" id="f_sangre"></label>
                <label>Tel. Familiar: <input type="text" name="contacto_familiar" id="f_fam"></label>
                <label>Usa Lentes: <input type="checkbox" name="usa_lentes" id="f_lentes"></label>
                <button type="button" onclick="guardar()" class="btn-save">GUARDAR CAMBIOS</button>
            </form>
        </div>

        <div id="map" style="height: 400px; margin-top:20px; border-radius:10px;"></div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = L.map('map').setView([8.62, -70.20], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = {};

        async function init() {
            const res = await fetch('/api/usuarios');
            const data = await res.json();
            const sel = document.getElementById('selector');
            data.filter(u => u.rol === 'chofer').forEach(u => {
                sel.innerHTML += `<option value="${u.cedula_id}">${u.cedula_id} - ${u.nombre}</option>`;
            });
        }

        async function cargar(id) {
            const res = await fetch(`/api/usuarios?id=${id}`);
            const u = await res.json();
            document.getElementById('f_id').value = u.cedula_id;
            document.getElementById('f_nombre').value = u.nombre;
            document.getElementById('f_placa').value = u.placa_buseta;
            document.getElementById('f_serial').value = u.serial_motor || '';
            document.getElementById('f_sangre').value = u.tipo_sangre || '';
            document.getElementById('f_fam').value = u.contacto_familiar || '';
            document.getElementById('f_lentes').checked = u.usa_lentes === 1;
        }

        async function guardar() {
            const data = Object.fromEntries(new FormData(document.getElementById('perfilForm')));
            data.usa_lentes = document.getElementById('f_lentes').checked;
            await fetch('/api/usuarios/update', { method:'POST', body: JSON.stringify(data) });
            alert("Datos actualizados.");
        }

        setInterval(async () => {
            const res = await fetch('/api/mapa-vivo');
            const data = await res.json();
            data.forEach(u => {
                if(markers[u.cedula_id]) markers[u.cedula_id].setLatLng([u.ultima_latitud, u.ultima_longitud]);
                else markers[u.cedula_id] = L.marker([u.ultima_latitud, u.ultima_longitud]).addTo(map).bindPopup(u.cedula_id);
            });
        }, 10000);

        window.onload = init;
    </script>
</body>
</html>
